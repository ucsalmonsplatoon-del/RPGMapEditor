<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPGãƒãƒƒãƒ—ã‚¨ãƒ‡ã‚£ã‚¿ - ã‚¿ã‚¤ãƒ«é…ç½®ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 15px;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn.success {
            background: #48bb78;
        }

        .btn.success:hover {
            background: #38a169;
        }

        .btn.danger {
            background: #f56565;
        }

        .btn.danger:hover {
            background: #e53e3e;
        }

        .btn.warning {
            background: #ed8936;
        }

        .btn.warning:hover {
            background: #dd6b20;
        }

        input[type="file"] {
            display: none;
        }

        .main-container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .left-panel {
            width: 350px;
            min-width: 300px;
            resize: horizontal;
            overflow: auto;
        }

        .right-panel {
            flex: 1;
            min-width: 600px;
        }

        .panel-header {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .canvas-container {
            position: relative;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            overflow: auto;
            flex: 1;
            background: #f7fafc;
            transition: all 0.3s;
        }

        .canvas-container.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        .drop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            z-index: 1000;
            pointer-events: none;
        }

        .canvas-container.dragover .drop-overlay {
            display: flex;
        }

        #tilesetCanvas, #mapCanvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            transform-origin: top left;
        }

        #tilesetSelection {
            position: absolute;
            border: 3px solid #667eea;
            background: rgba(102, 126, 234, 0.3);
            pointer-events: none;
            display: none;
            z-index: 10;
        }

        .map-container {
            position: relative;
            overflow: auto;
            flex: 1;
        }

        #mapCanvas {
            background: white;
            transform-origin: top left;
        }

        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .zoom-btn {
            background: #667eea;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 2px;
            font-size: 18px;
        }

        .zoom-btn:hover {
            background: #5a67d8;
        }

        .zoom-level {
            display: inline-block;
            margin: 0 10px;
            font-size: 14px;
            color: #4a5568;
            min-width: 50px;
            text-align: center;
        }

        .object-wrapper {
            position: absolute;
            border: 2px dashed #667eea;
            cursor: move;
            background: rgba(102, 126, 234, 0.1);
        }

        .object-wrapper:hover {
            border-color: #f56565;
            background: rgba(245, 101, 101, 0.1);
        }

        .object-wrapper.selected {
            border: 2px solid #f56565;
            background: rgba(245, 101, 101, 0.2);
        }

        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #667eea;
            border: 2px solid white;
            display: none;
        }

        .object-wrapper.selected .resize-handle {
            display: block;
        }

        .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }

        .controls {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
        }

        .control-group {
            margin-bottom: 10px;
        }

        .control-group label {
            display: block;
            color: #4a5568;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .info-box {
            background: #edf2f7;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            color: #4a5568;
        }

        .object-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            background: #f7fafc;
        }

        .canvas-container.panning {
            cursor: grab !important;
        }

        .canvas-container.panning * {
            cursor: grab !important;
        }

        .object-item {
            padding: 5px 10px;
            margin-bottom: 5px;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .object-item:hover {
            background: #edf2f7;
        }

        .object-item.selected {
            background: #667eea;
            color: white;
        }

        .delete-btn {
            background: #f56565;
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .mode-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #cbd5e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ—ºï¸ RPGãƒãƒƒãƒ—ã‚¨ãƒ‡ã‚£ã‚¿</h1>
        <div class="toolbar">
            <label class="btn">
                ğŸ“ ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆèª­è¾¼
                <input type="file" id="tilesetInput" accept="image/*">
            </label>
            <label class="btn">
                ğŸ—ºï¸ ãƒãƒƒãƒ—ç”»åƒèª­è¾¼
                <input type="file" id="mapInput" accept="image/*">
            </label>
            <button class="btn success" id="saveProjectBtn">ğŸ’¾ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜</button>
            <label class="btn success">
                ğŸ“‚ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­è¾¼
                <input type="file" id="loadProjectBtn" accept=".json">
            </label>
            <button class="btn warning" id="exportPngBtn">ğŸ–¼ï¸ PNGå‡ºåŠ›</button>
            <button class="btn danger" id="clearAllBtn">ğŸ—‘ï¸ å…¨ã‚¯ãƒªã‚¢</button>
        </div>
    </div>

    <div class="main-container">
        <div class="panel left-panel">
            <div class="panel-header">ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆ</div>
            <div class="canvas-container" id="tilesetContainer">
                <canvas id="tilesetCanvas"></canvas>
                <div id="tilesetSelection"></div>
                <div class="drop-overlay">ğŸ“ ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>
                <div class="zoom-controls">
                    <button class="zoom-btn" id="tilesetZoomOutBtn">âˆ’</button>
                    <span class="zoom-level" id="tilesetZoomLevel">100%</span>
                    <button class="zoom-btn" id="tilesetZoomInBtn">+</button>
                    <button class="zoom-btn" id="tilesetZoomResetBtn">âŸ²</button>
                </div>
            </div>
            <div class="controls">
                <div class="info-box" id="selectionInfo">
                    é¸æŠ: ãªã—
                </div>
            </div>
        </div>

        <div class="panel right-panel">
            <div class="panel-header">ãƒãƒƒãƒ—</div>
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="place">é…ç½®ãƒ¢ãƒ¼ãƒ‰</button>
                <button class="mode-btn" data-mode="edit">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
            </div>
            <div class="canvas-container map-container" id="mapContainer">
                <canvas id="mapCanvas"></canvas>
                <div class="drop-overlay">ğŸ—ºï¸ ãƒãƒƒãƒ—ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomOutBtn">âˆ’</button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="zoom-btn" id="zoomInBtn">+</button>
                    <button class="zoom-btn" id="zoomResetBtn">âŸ²</button>
                </div>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label>é…ç½®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</label>
                    <div class="object-list" id="objectList"></div>
                </div>
                <div class="info-box">
                    ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ•°: <span id="objectCount">0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let tilesetImage = null;
        let mapImage = null;
        let tilesetSelection = null;
        let isSelectingTile = false;
        let selectStartX, selectStartY;
        let placedObjects = [];
        let selectedObject = null;
        let currentMode = 'place';
        let objectIdCounter = 1;

        // ãƒã‚¦ã‚¹æ“ä½œç”¨
        let isDragging = false;
        let isResizing = false;
        let dragStartX, dragStartY;
        let resizeHandle = null;

        // ãƒ‘ãƒ³ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ç”¨
        let isPanningMap = false;
        let isPanningTileset = false;
        let panStartX, panStartY;
        let panStartScrollLeft, panStartScrollTop;

        // ã‚ºãƒ¼ãƒ é–¢é€£
        let mapZoomLevel = 1;
        let tilesetZoomLevel = 1;
        const MIN_ZOOM = 0.25;
        const MAX_ZOOM = 4;
        const ZOOM_STEP = 0.1;

        // å±¥æ­´ç®¡ç†
        let history = [];
        let historyIndex = -1;
        const MAX_HISTORY = 50;

        // Canvasè¦ç´ 
        const tilesetCanvas = document.getElementById('tilesetCanvas');
        const tilesetCtx = tilesetCanvas.getContext('2d');
        const mapCanvas = document.getElementById('mapCanvas');
        const mapCtx = mapCanvas.getContext('2d');
        const mapContainer = document.getElementById('mapContainer');
        const tilesetContainer = document.getElementById('tilesetContainer');
        const tilesetSelectionDiv = document.getElementById('tilesetSelection');

        // ç”»åƒèª­ã¿è¾¼ã¿å‡¦ç†
        function loadTilesetImage(file) {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    tilesetImage = new Image();
                    tilesetImage.onload = () => {
                        tilesetCanvas.width = tilesetImage.width;
                        tilesetCanvas.height = tilesetImage.height;
                        tilesetCtx.drawImage(tilesetImage, 0, 0);
                    };
                    tilesetImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function loadMapImage(file) {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    mapImage = new Image();
                    mapImage.onload = () => {
                        mapCanvas.width = mapImage.width;
                        mapCanvas.height = mapImage.height;
                        redrawMap();
                    };
                    mapImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã§ã®èª­ã¿è¾¼ã¿
        document.getElementById('tilesetInput').addEventListener('change', (e) => {
            loadTilesetImage(e.target.files[0]);
        });

        document.getElementById('mapInput').addEventListener('change', (e) => {
            loadMapImage(e.target.files[0]);
        });

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— - ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆ
        tilesetContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            tilesetContainer.classList.add('dragover');
        });

        tilesetContainer.addEventListener('dragleave', (e) => {
            if (e.currentTarget === tilesetContainer && !tilesetContainer.contains(e.relatedTarget)) {
                tilesetContainer.classList.remove('dragover');
            }
        });

        tilesetContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            tilesetContainer.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                loadTilesetImage(files[0]);
            }
        });

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— - ãƒãƒƒãƒ—
        mapContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            mapContainer.classList.add('dragover');
        });

        mapContainer.addEventListener('dragleave', (e) => {
            if (e.currentTarget === mapContainer && !mapContainer.contains(e.relatedTarget)) {
                mapContainer.classList.remove('dragover');
            }
        });

        mapContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            mapContainer.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                loadMapImage(files[0]);
            }
        });

        // ãƒšãƒ¼ã‚¸å…¨ä½“ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼ã‚’é˜²ã
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
        });

        // ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆé¸æŠ
        tilesetCanvas.addEventListener('mousedown', (e) => {
            if (!tilesetImage) return;

            const rect = tilesetCanvas.getBoundingClientRect();
            selectStartX = (e.clientX - rect.left) / tilesetZoomLevel;
            selectStartY = (e.clientY - rect.top) / tilesetZoomLevel;
            isSelectingTile = true;

            tilesetSelectionDiv.style.display = 'block';
            tilesetSelectionDiv.style.left = (selectStartX * tilesetZoomLevel) + 'px';
            tilesetSelectionDiv.style.top = (selectStartY * tilesetZoomLevel) + 'px';
            tilesetSelectionDiv.style.width = '0px';
            tilesetSelectionDiv.style.height = '0px';
        });

        tilesetCanvas.addEventListener('mousemove', (e) => {
            if (!isSelectingTile) return;

            const rect = tilesetCanvas.getBoundingClientRect();
            const currentX = (e.clientX - rect.left) / tilesetZoomLevel;
            const currentY = (e.clientY - rect.top) / tilesetZoomLevel;

            const left = Math.min(selectStartX, currentX);
            const top = Math.min(selectStartY, currentY);
            const width = Math.abs(currentX - selectStartX);
            const height = Math.abs(currentY - selectStartY);

            tilesetSelectionDiv.style.left = (left * tilesetZoomLevel) + 'px';
            tilesetSelectionDiv.style.top = (top * tilesetZoomLevel) + 'px';
            tilesetSelectionDiv.style.width = (width * tilesetZoomLevel) + 'px';
            tilesetSelectionDiv.style.height = (height * tilesetZoomLevel) + 'px';
        });

        tilesetCanvas.addEventListener('mouseup', (e) => {
            if (!isSelectingTile) return;
            isSelectingTile = false;

            const rect = tilesetCanvas.getBoundingClientRect();
            const endX = (e.clientX - rect.left) / tilesetZoomLevel;
            const endY = (e.clientY - rect.top) / tilesetZoomLevel;

            const left = Math.min(selectStartX, endX);
            const top = Math.min(selectStartY, endY);
            const width = Math.abs(endX - selectStartX);
            const height = Math.abs(endY - selectStartY);

            if (width > 5 && height > 5) {
                tilesetSelection = { x: left, y: top, width, height };
                document.getElementById('selectionInfo').textContent =
                    `é¸æŠ: ${Math.round(width)}Ã—${Math.round(height)}px`;
            }
        });

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
            });
        });

        // å±¥æ­´ã‚’ä¿å­˜
        function saveHistory() {
            // ç¾åœ¨ã®ä½ç½®ã‚ˆã‚Šå…ˆã®å±¥æ­´ã‚’å‰Šé™¤
            history = history.slice(0, historyIndex + 1);

            // æ–°ã—ã„çŠ¶æ…‹ã‚’ä¿å­˜
            const state = {
                objects: placedObjects.map(obj => ({...obj})),
                objectIdCounter: objectIdCounter
            };
            history.push(JSON.parse(JSON.stringify(state)));

            // å±¥æ­´ã®æœ€å¤§æ•°ã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
            if (history.length > MAX_HISTORY) {
                history.shift();
            } else {
                historyIndex++;
            }
        }

        // å±¥æ­´ã‹ã‚‰å¾©å…ƒ
        function restoreHistory(index) {
            if (index < 0 || index >= history.length) return;

            const state = history[index];
            placedObjects = state.objects.map(obj => ({...obj}));

            // objectIdCounterã‚’æ­£ã—ãå¾©å…ƒï¼ˆä¿å­˜ã•ã‚Œã¦ã„ãªã„å ´åˆã¯æœ€å¤§ID+1ã‚’ä½¿ç”¨ï¼‰
            if (state.objectIdCounter) {
                objectIdCounter = state.objectIdCounter;
            } else if (placedObjects.length > 0) {
                const maxId = Math.max(...placedObjects.map(obj => obj.id));
                objectIdCounter = maxId + 1;
            } else {
                objectIdCounter = 1;
            }

            // DOMè¦ç´ ã‚’å†ä½œæˆ
            document.querySelectorAll('.object-wrapper').forEach(w => w.remove());
            placedObjects.forEach(obj => createObjectElement(obj));

            redrawMap();
            updateObjectList();
        }

        // ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ã§é…ç½®
        mapCanvas.addEventListener('click', (e) => {
            if (currentMode !== 'place' || !tilesetSelection || !tilesetImage) return;

            const rect = mapCanvas.getBoundingClientRect();
            // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’è€ƒæ…®ã—ãŸåº§æ¨™è¨ˆç®—
            const x = (e.clientX - rect.left) / mapZoomLevel;
            const y = (e.clientY - rect.top) / mapZoomLevel;

            // é¸æŠç¯„å›²ã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = tilesetSelection.width;
            tempCanvas.height = tilesetSelection.height;
            const tempCtx = tempCanvas.getContext('2d');

            tempCtx.drawImage(
                tilesetImage,
                tilesetSelection.x, tilesetSelection.y,
                tilesetSelection.width, tilesetSelection.height,
                0, 0,
                tilesetSelection.width, tilesetSelection.height
            );

            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
            const newObject = {
                id: objectIdCounter++,
                x: x - tilesetSelection.width / 2,
                y: y - tilesetSelection.height / 2,
                width: tilesetSelection.width,
                height: tilesetSelection.height,
                imageData: tempCanvas.toDataURL(),
                sourceSelection: {...tilesetSelection}
            };

            saveHistory();
            placedObjects.push(newObject);
            createObjectElement(newObject);
            redrawMap();
            updateObjectList();
        });

        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¦ç´ ã‚’ä½œæˆ
        function createObjectElement(obj) {
            const wrapper = document.createElement('div');
            wrapper.className = 'object-wrapper';
            wrapper.dataset.id = obj.id;
            wrapper.style.left = (obj.x * mapZoomLevel) + 'px';
            wrapper.style.top = (obj.y * mapZoomLevel) + 'px';
            wrapper.style.width = (obj.width * mapZoomLevel) + 'px';
            wrapper.style.height = (obj.height * mapZoomLevel) + 'px';

            // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«è¿½åŠ 
            ['nw', 'ne', 'sw', 'se'].forEach(pos => {
                const handle = document.createElement('div');
                handle.className = `resize-handle ${pos}`;
                handle.dataset.position = pos;
                wrapper.appendChild(handle);
            });

            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”»åƒ
            const img = document.createElement('img');
            img.src = obj.imageData;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.pointerEvents = 'none';
            img.style.imageRendering = 'pixelated';
            wrapper.appendChild(img);

            mapContainer.appendChild(wrapper);

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            wrapper.addEventListener('mousedown', handleObjectMouseDown);
        }

        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³å‡¦ç†
        function handleObjectMouseDown(e) {
            if (currentMode !== 'edit') return;

            const wrapper = e.currentTarget;
            const objId = parseInt(wrapper.dataset.id);
            selectedObject = placedObjects.find(obj => obj.id === objId);

            // é¸æŠçŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.object-wrapper').forEach(w => w.classList.remove('selected'));
            wrapper.classList.add('selected');

            // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã‚¯ãƒªãƒƒã‚¯ãƒã‚§ãƒƒã‚¯
            if (e.target.classList.contains('resize-handle')) {
                isResizing = true;
                resizeHandle = e.target.dataset.position;
            } else {
                isDragging = true;
            }

            dragStartX = e.clientX;
            dragStartY = e.clientY;

            e.preventDefault();
        }

        // ãƒã‚¦ã‚¹ç§»å‹•å‡¦ç†ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”¨ï¼‰
        document.addEventListener('mousemove', (e) => {
            // ãƒ‘ãƒ³ä¸­ã¯ä»–ã®å‡¦ç†ã‚’ã—ãªã„
            if (isPanningMap || isPanningTileset) {
                if (isPanningMap) {
                    const deltaX = e.clientX - panStartX;
                    const deltaY = e.clientY - panStartY;
                    mapContainer.scrollLeft = panStartScrollLeft - deltaX;
                    mapContainer.scrollTop = panStartScrollTop - deltaY;
                }
                if (isPanningTileset) {
                    const deltaX = e.clientX - panStartX;
                    const deltaY = e.clientY - panStartY;
                    tilesetContainer.scrollLeft = panStartScrollLeft - deltaX;
                    tilesetContainer.scrollTop = panStartScrollTop - deltaY;
                }
                return;
            }

            if (!selectedObject) return;

            const deltaX = e.clientX - dragStartX;
            const deltaY = e.clientY - dragStartY;

            if (isDragging) {
                selectedObject.x += deltaX / mapZoomLevel;
                selectedObject.y += deltaY / mapZoomLevel;

                const wrapper = document.querySelector(`.object-wrapper[data-id="${selectedObject.id}"]`);
                wrapper.style.left = (selectedObject.x * mapZoomLevel) + 'px';
                wrapper.style.top = (selectedObject.y * mapZoomLevel) + 'px';

                dragStartX = e.clientX;
                dragStartY = e.clientY;
            } else if (isResizing) {
                let newWidth = selectedObject.width;
                let newHeight = selectedObject.height;
                let newX = selectedObject.x;
                let newY = selectedObject.y;

                const scaledDeltaX = deltaX / mapZoomLevel;
                const scaledDeltaY = deltaY / mapZoomLevel;

                switch(resizeHandle) {
                    case 'se':
                        newWidth += scaledDeltaX;
                        newHeight += scaledDeltaY;
                        break;
                    case 'sw':
                        newWidth -= scaledDeltaX;
                        newHeight += scaledDeltaY;
                        newX += scaledDeltaX;
                        break;
                    case 'ne':
                        newWidth += scaledDeltaX;
                        newHeight -= scaledDeltaY;
                        newY += scaledDeltaY;
                        break;
                    case 'nw':
                        newWidth -= scaledDeltaX;
                        newHeight -= scaledDeltaY;
                        newX += scaledDeltaX;
                        newY += scaledDeltaY;
                        break;
                }

                if (newWidth > 20 && newHeight > 20) {
                    selectedObject.width = newWidth;
                    selectedObject.height = newHeight;
                    selectedObject.x = newX;
                    selectedObject.y = newY;

                    const wrapper = document.querySelector(`.object-wrapper[data-id="${selectedObject.id}"]`);
                    wrapper.style.left = (newX * mapZoomLevel) + 'px';
                    wrapper.style.top = (newY * mapZoomLevel) + 'px';
                    wrapper.style.width = (newWidth * mapZoomLevel) + 'px';
                    wrapper.style.height = (newHeight * mapZoomLevel) + 'px';

                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                }
            }
        });

        // ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—å‡¦ç†
        document.addEventListener('mouseup', () => {
            if (isDragging || isResizing) {
                saveHistory();
                redrawMap();
            }
            isDragging = false;
            isResizing = false;
            resizeHandle = null;
        });

        // ã‚ºãƒ¼ãƒ æ©Ÿèƒ½
        function updateMapZoom(newZoom) {
            mapZoomLevel = Math.min(MAX_ZOOM, Math.max(MIN_ZOOM, newZoom));
            mapCanvas.style.transform = `scale(${mapZoomLevel})`;
            document.getElementById('zoomLevel').textContent = Math.round(mapZoomLevel * 100) + '%';

            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¦ç´ ã®ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’æ›´æ–°
            document.querySelectorAll('.object-wrapper').forEach(wrapper => {
                const objId = parseInt(wrapper.dataset.id);
                const obj = placedObjects.find(o => o.id === objId);
                if (obj) {
                    wrapper.style.left = (obj.x * mapZoomLevel) + 'px';
                    wrapper.style.top = (obj.y * mapZoomLevel) + 'px';
                    wrapper.style.width = (obj.width * mapZoomLevel) + 'px';
                    wrapper.style.height = (obj.height * mapZoomLevel) + 'px';
                }
            });
        }

        function updateTilesetZoom(newZoom) {
            tilesetZoomLevel = Math.min(MAX_ZOOM, Math.max(MIN_ZOOM, newZoom));
            tilesetCanvas.style.transform = `scale(${tilesetZoomLevel})`;
            document.getElementById('tilesetZoomLevel').textContent = Math.round(tilesetZoomLevel * 100) + '%';

            // é¸æŠç¯„å›²ã®è¡¨ç¤ºã‚’æ›´æ–°
            if (tilesetSelection) {
                tilesetSelectionDiv.style.left = (tilesetSelection.x * tilesetZoomLevel) + 'px';
                tilesetSelectionDiv.style.top = (tilesetSelection.y * tilesetZoomLevel) + 'px';
                tilesetSelectionDiv.style.width = (tilesetSelection.width * tilesetZoomLevel) + 'px';
                tilesetSelectionDiv.style.height = (tilesetSelection.height * tilesetZoomLevel) + 'px';
            }
        }

        // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ  - ãƒãƒƒãƒ—
        mapContainer.addEventListener('wheel', (e) => {
            if (!e.ctrlKey && !e.shiftKey) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -ZOOM_STEP : ZOOM_STEP;
                updateMapZoom(mapZoomLevel + delta);
            }
        });

        // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ  - ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆ
        tilesetContainer.addEventListener('wheel', (e) => {
            if (!e.ctrlKey && !e.shiftKey) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -ZOOM_STEP : ZOOM_STEP;
                updateTilesetZoom(tilesetZoomLevel + delta);
            }
        });

        // ãƒ‘ãƒ³æ©Ÿèƒ½ - ãƒãƒƒãƒ—
        mapContainer.addEventListener('mousedown', (e) => {
            if (e.button === 1) { // ä¸­ãƒœã‚¿ãƒ³
                e.preventDefault();
                isPanningMap = true;
                panStartX = e.clientX;
                panStartY = e.clientY;
                panStartScrollLeft = mapContainer.scrollLeft;
                panStartScrollTop = mapContainer.scrollTop;
                mapContainer.classList.add('panning');
                mapContainer.style.cursor = 'grabbing';
            }
        });

        // ãƒ‘ãƒ³æ©Ÿèƒ½ - ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆ
        tilesetContainer.addEventListener('mousedown', (e) => {
            if (e.button === 1) { // ä¸­ãƒœã‚¿ãƒ³
                e.preventDefault();
                isPanningTileset = true;
                panStartX = e.clientX;
                panStartY = e.clientY;
                panStartScrollLeft = tilesetContainer.scrollLeft;
                panStartScrollTop = tilesetContainer.scrollTop;
                tilesetContainer.classList.add('panning');
                tilesetContainer.style.cursor = 'grabbing';
            }
        });


        // ãƒ‘ãƒ³çµ‚äº†å‡¦ç†
        document.addEventListener('mouseup', (e) => {
            if (e.button === 1) {
                if (isPanningMap) {
                    isPanningMap = false;
                    mapContainer.classList.remove('panning');
                    mapContainer.style.cursor = '';
                }
                if (isPanningTileset) {
                    isPanningTileset = false;
                    tilesetContainer.classList.remove('panning');
                    tilesetContainer.style.cursor = '';
                }
            }
        });

        // ä¸­ã‚¯ãƒªãƒƒã‚¯ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’é˜²ã
        document.addEventListener('auxclick', (e) => {
            if (e.button === 1) {
                e.preventDefault();
            }
        });

        // ã‚ºãƒ¼ãƒ ãƒœã‚¿ãƒ³ - ãƒãƒƒãƒ—
        document.getElementById('zoomInBtn').addEventListener('click', () => {
            updateMapZoom(mapZoomLevel + ZOOM_STEP);
        });

        document.getElementById('zoomOutBtn').addEventListener('click', () => {
            updateMapZoom(mapZoomLevel - ZOOM_STEP);
        });

        document.getElementById('zoomResetBtn').addEventListener('click', () => {
            updateMapZoom(1);
        });

        // ã‚ºãƒ¼ãƒ ãƒœã‚¿ãƒ³ - ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆ
        document.getElementById('tilesetZoomInBtn').addEventListener('click', () => {
            updateTilesetZoom(tilesetZoomLevel + ZOOM_STEP);
        });

        document.getElementById('tilesetZoomOutBtn').addEventListener('click', () => {
            updateTilesetZoom(tilesetZoomLevel - ZOOM_STEP);
        });

        document.getElementById('tilesetZoomResetBtn').addEventListener('click', () => {
            updateTilesetZoom(1);
        });

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (e) => {
            // Delete - ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
            if (e.key === 'Delete' && selectedObject) {
                saveHistory();
                placedObjects = placedObjects.filter(obj => obj.id !== selectedObject.id);
                const wrapper = document.querySelector(`.object-wrapper[data-id="${selectedObject.id}"]`);
                wrapper.remove();
                selectedObject = null;
                redrawMap();
                updateObjectList();
            }

            // Ctrl+Z - å…ƒã«æˆ»ã™
            if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                if (historyIndex > 0) {
                    historyIndex--;
                    restoreHistory(historyIndex);
                }
            }

            // Ctrl+Y ã¾ãŸã¯ Ctrl+Shift+Z - ã‚„ã‚Šç›´ã™
            if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'Z')) {
                e.preventDefault();
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    restoreHistory(historyIndex);
                }
            }

            // Ctrl+Plus - ã‚ºãƒ¼ãƒ ã‚¤ãƒ³ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¨ãƒªã‚¢ã«å¿œã˜ã¦ï¼‰
            if (e.ctrlKey && (e.key === '+' || e.key === '=')) {
                e.preventDefault();
                // ãƒã‚¦ã‚¹ä½ç½®ã§ã©ã¡ã‚‰ã®ãƒ‘ãƒãƒ«ã‹åˆ¤å®š
                const mouseTarget = document.elementFromPoint(e.clientX || 0, e.clientY || 0);
                if (mouseTarget && mouseTarget.closest('#tilesetContainer')) {
                    updateTilesetZoom(tilesetZoomLevel + ZOOM_STEP);
                } else {
                    updateMapZoom(mapZoomLevel + ZOOM_STEP);
                }
            }

            // Ctrl+Minus - ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¨ãƒªã‚¢ã«å¿œã˜ã¦ï¼‰
            if (e.ctrlKey && e.key === '-') {
                e.preventDefault();
                const mouseTarget = document.elementFromPoint(e.clientX || 0, e.clientY || 0);
                if (mouseTarget && mouseTarget.closest('#tilesetContainer')) {
                    updateTilesetZoom(tilesetZoomLevel - ZOOM_STEP);
                } else {
                    updateMapZoom(mapZoomLevel - ZOOM_STEP);
                }
            }

            // Ctrl+0 - ã‚ºãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¨ãƒªã‚¢ã«å¿œã˜ã¦ï¼‰
            if (e.ctrlKey && e.key === '0') {
                e.preventDefault();
                const mouseTarget = document.elementFromPoint(e.clientX || 0, e.clientY || 0);
                if (mouseTarget && mouseTarget.closest('#tilesetContainer')) {
                    updateTilesetZoom(1);
                } else {
                    updateMapZoom(1);
                }
            }
        });

        // ãƒãƒƒãƒ—å†æç”»
        function redrawMap() {
            if (mapImage) {
                mapCtx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
                mapCtx.drawImage(mapImage, 0, 0);
            } else {
                mapCtx.fillStyle = 'white';
                mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
            }

            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæç”»
            placedObjects.forEach(obj => {
                const img = new Image();
                img.onload = () => {
                    mapCtx.drawImage(img, obj.x, obj.y, obj.width, obj.height);
                };
                img.src = obj.imageData;
            });
        }

        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒªã‚¹ãƒˆæ›´æ–°
        function updateObjectList() {
            const list = document.getElementById('objectList');
            list.innerHTML = '';

            placedObjects.forEach((obj, index) => {
                const item = document.createElement('div');
                item.className = 'object-item';
                item.innerHTML = `
                    <span>ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ ${obj.id}</span>
                    <button class="delete-btn" data-id="${obj.id}">å‰Šé™¤</button>
                `;
                list.appendChild(item);

                item.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    saveHistory();
                    placedObjects = placedObjects.filter(o => o.id !== obj.id);
                    const wrapper = document.querySelector(`.object-wrapper[data-id="${obj.id}"]`);
                    if (wrapper) wrapper.remove();
                    redrawMap();
                    updateObjectList();
                });
            });

            document.getElementById('objectCount').textContent = placedObjects.length;
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜
        document.getElementById('saveProjectBtn').addEventListener('click', () => {
            const projectData = {
                objects: placedObjects,
                objectIdCounter: objectIdCounter,
                mapImageData: mapImage ? mapCanvas.toDataURL() : null,
                tilesetImageData: tilesetImage ? tilesetCanvas.toDataURL() : null,
                canvasSize: {
                    width: mapCanvas.width,
                    height: mapCanvas.height
                }
            };

            const dataStr = JSON.stringify(projectData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = 'map_project.json';
            link.href = url;
            link.click();
        });

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿
        document.getElementById('loadProjectBtn').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const projectData = JSON.parse(e.target.result);

                    // ãƒãƒƒãƒ—ç”»åƒå¾©å…ƒ
                    if (projectData.mapImageData) {
                        mapImage = new Image();
                        mapImage.onload = () => {
                            mapCanvas.width = projectData.canvasSize.width;
                            mapCanvas.height = projectData.canvasSize.height;
                            redrawMap();
                        };
                        mapImage.src = projectData.mapImageData;
                    }

                    // ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆå¾©å…ƒ
                    if (projectData.tilesetImageData) {
                        tilesetImage = new Image();
                        tilesetImage.onload = () => {
                            tilesetCanvas.width = tilesetImage.width;
                            tilesetCanvas.height = tilesetImage.height;
                            tilesetCtx.drawImage(tilesetImage, 0, 0);
                        };
                        tilesetImage.src = projectData.tilesetImageData;
                    }

                    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå¾©å…ƒ
                    document.querySelectorAll('.object-wrapper').forEach(w => w.remove());
                    placedObjects = projectData.objects || [];

                    // objectIdCounterã‚’å¾©å…ƒï¼ˆä¿å­˜ã•ã‚Œã¦ã„ãªã„å¤ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯è¨ˆç®—ï¼‰
                    if (projectData.objectIdCounter) {
                        objectIdCounter = projectData.objectIdCounter;
                    } else if (placedObjects.length > 0) {
                        const maxId = Math.max(...placedObjects.map(obj => obj.id));
                        objectIdCounter = maxId + 1;
                    } else {
                        objectIdCounter = 1;
                    }

                    placedObjects.forEach(obj => createObjectElement(obj));
                    updateObjectList();

                    // å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
                    history = [];
                    historyIndex = -1;
                    saveHistory();
                };
                reader.readAsText(file);
            }
        });

        // PNGå‡ºåŠ›
        document.getElementById('exportPngBtn').addEventListener('click', () => {
            // ä¸€æ™‚ã‚­ãƒ£ãƒ³ãƒã‚¹ä½œæˆ
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = mapCanvas.width;
            exportCanvas.height = mapCanvas.height;
            const exportCtx = exportCanvas.getContext('2d');

            // ãƒãƒƒãƒ—æç”»
            if (mapImage) {
                exportCtx.drawImage(mapImage, 0, 0);
            } else {
                exportCtx.fillStyle = 'white';
                exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
            }

            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæç”»ï¼ˆé †ç•ªã«å¾…ã¤å¿…è¦ã‚ã‚Šï¼‰
            let loadCount = 0;

            if (placedObjects.length === 0) {
                downloadCanvas(exportCanvas);
                return;
            }

            placedObjects.forEach(obj => {
                const img = new Image();
                img.onload = () => {
                    exportCtx.drawImage(img, obj.x, obj.y, obj.width, obj.height);
                    loadCount++;
                    if (loadCount === placedObjects.length) {
                        downloadCanvas(exportCanvas);
                    }
                };
                img.src = obj.imageData;
            });
        });

        function downloadCanvas(canvas) {
            const link = document.createElement('a');
            link.download = 'map_export.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // å…¨ã‚¯ãƒªã‚¢
        document.getElementById('clearAllBtn').addEventListener('click', () => {
            if (confirm('ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                saveHistory();
                placedObjects = [];
                objectIdCounter = 1;  // IDã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚‚ãƒªã‚»ãƒƒãƒˆ
                document.querySelectorAll('.object-wrapper').forEach(w => w.remove());
                redrawMap();
                updateObjectList();
            }
        });

        // åˆæœŸè¨­å®š
        mapCanvas.width = 800;
        mapCanvas.height = 600;
        mapCtx.fillStyle = 'white';
        mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);

        // åˆæœŸå±¥æ­´ã‚’ä¿å­˜
        saveHistory();
    </script>
</body>
</html>